name: Retag Packages

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  retag:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install crane
        run: |
          curl -sL https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz | tar -xz crane
          sudo mv crane /usr/local/bin/

      - name: Retag openclaw-v2026.1.30 to v2026.1.30
        run: |
          OLD_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:openclaw-v2026.1.30"
          NEW_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v2026.1.30"

          echo "Copying $OLD_TAG to $NEW_TAG"
          crane copy "$OLD_TAG" "$NEW_TAG" || echo "Failed to copy tag"

      - name: Delete old tags
        run: |
          # List tags to delete (with openclaw- prefix)
          OLD_TAGS="openclaw-v2026.1.30"

          for tag in $OLD_TAGS; do
            echo "Deleting tag: $tag"
            crane delete "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$tag" || echo "Failed to delete $tag"
          done
