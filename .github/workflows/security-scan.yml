name: Security Scan

on:
  schedule:
    # Daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  BASE_IMAGE: ghcr.io/${{ github.repository_owner }}/openclaw-base:latest

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
      actions: write

    outputs:
      critical_count: ${{ steps.scan.outputs.critical }}
      high_count: ${{ steps.scan.outputs.high }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull base image
        run: docker pull ${{ env.BASE_IMAGE }} || echo "Image not found, will skip scan"

      - name: Run Trivy vulnerability scanner
        id: scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.BASE_IMAGE }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Count vulnerabilities
        id: count
        run: |
          if [ -f trivy-results.sarif ]; then
            CRITICAL=$(cat trivy-results.sarif | jq '[.runs[].results[] | select(.level == "error")] | length')
            HIGH=$(cat trivy-results.sarif | jq '[.runs[].results[] | select(.level == "warning")] | length')
          else
            CRITICAL=0
            HIGH=0
          fi
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "Found $CRITICAL critical and $HIGH high vulnerabilities"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Create summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.BASE_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${{ steps.count.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${{ steps.count.outputs.high }} |" >> $GITHUB_STEP_SUMMARY

  rebuild-if-vulnerable:
    needs: scan
    if: needs.scan.outputs.critical_count > 0
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Trigger base image rebuild
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Critical vulnerabilities found, triggering base image rebuild...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-base.yml',
              ref: 'main'
            });
            console.log('Base image rebuild triggered successfully');

      - name: Create issue for tracking
        uses: actions/github-script@v7
        with:
          script: |
            const critical = ${{ needs.scan.outputs.critical_count }};
            const high = ${{ needs.scan.outputs.high_count }};

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security: ${critical} critical vulnerabilities in base image`,
                body: `## Automated Security Alert\n\nThe daily security scan found vulnerabilities in the base image:\n\n| Severity | Count |\n|----------|-------|\n| Critical | ${critical} |\n| High | ${high} |\n\n**Action taken:** Base image rebuild has been triggered automatically.\n\nPlease review the [Security tab](../../security/code-scanning) for details.\n\n---\n*This issue was created automatically by the security scan workflow.*`,
                labels: ['security', 'automated']
              });
            }
