name: Watch OpenClaw Releases

on:
  schedule:
    - cron: '0 0 * * *'  # Every day at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Get latest openclaw release
        id: fetch
        run: |
          LATEST=$(gh release view -R openclaw/openclaw --json tagName -q .tagName)
          echo "Latest openclaw release: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore cached version
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: .last-version
          key: openclaw-version-${{ steps.fetch.outputs.version }}

      - name: Check if new release
        id: check
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" == "true" ]; then
            echo "Version ${{ steps.fetch.outputs.version }} already built"
            echo "new_release=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: ${{ steps.fetch.outputs.version }}"
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "version=${{ steps.fetch.outputs.version }}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-release
    if: needs.check-release.outputs.new_release == 'true'
    uses: ./.github/workflows/build.yml
    with:
      openclaw_version: ${{ needs.check-release.outputs.version }}
    secrets: inherit
    permissions:
      contents: read
      packages: write

  update-cache:
    needs: [check-release, build]
    if: needs.check-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create version file
        run: echo "${{ needs.check-release.outputs.version }}" > .last-version

      - name: Save version to cache
        uses: actions/cache/save@v4
        with:
          path: .last-version
          key: openclaw-version-${{ needs.check-release.outputs.version }}
