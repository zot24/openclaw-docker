name: Watch OpenClaw Releases

on:
  schedule:
    - cron: '0 0 * * *'  # Every day at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.check.outputs.new_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest openclaw release
        id: fetch
        run: |
          LATEST=$(gh release view -R openclaw/openclaw --json tagName -q .tagName)
          echo "Latest openclaw release: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if new release
        id: check
        run: |
          CURRENT=$(cat VERSION 2>/dev/null || echo "")
          LATEST="${{ steps.fetch.outputs.version }}"
          echo "Current VERSION file: $CURRENT"
          echo "Latest upstream release: $LATEST"
          if [ "$CURRENT" == "$LATEST" ]; then
            echo "Version $LATEST already tracked in VERSION file"
            echo "new_release=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: $LATEST (was: $CURRENT)"
            echo "new_release=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST" >> $GITHUB_OUTPUT
          fi

  update-version:
    needs: check-release
    if: needs.check-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update VERSION file
        run: echo "${{ needs.check-release.outputs.version }}" > VERSION

      - name: Commit VERSION file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          git diff --cached --quiet || git commit -m "chore: update VERSION to ${{ needs.check-release.outputs.version }}"
          git push

  build:
    needs: [check-release, update-version]
    if: needs.check-release.outputs.new_release == 'true'
    uses: ./.github/workflows/build.yml
    with:
      openclaw_version: ${{ needs.check-release.outputs.version }}
    secrets: inherit
    permissions:
      contents: read
      packages: write
